#!/usr/bin/env bash
# Script to install and configure HAProxy on the load balancer server (lb-01) 
# using the roundrobin algorithm for web-01 (44.203.40.15) and web-02 (13.221.14.191).

# 1. Update package list and install HAProxy
echo "Updating packages and installing HAProxy..."
sudo apt-get -y update
sudo apt-get -y install haproxy

# 2. Define the IP addresses of your web servers
WEB_01_IP="44.203.40.15"
WEB_02_IP="13.221.14.191"

# 3. Create the complete, clean HAProxy configuration content
# NOTE: The server identifiers are explicitly set to 'web-01' and 'web-02'
HAPROXY_CONFIG_CONTENT="
global
    log /dev/log    local0 notice
    user haproxy
    group haproxy

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Frontend: Listens on the Load Balancer's public IP on port 80
frontend http_front
    bind *:80
    default_backend http_back

# Backend: Defines the web servers and load balancing method
backend http_back
    balance roundrobin
    # CRITICAL FIX: Using 'web-01' and 'web-02' as the server identifier names
    server web-01 $WEB_01_IP:80 check
    server web-02 $WEB_02_IP:80 check
"

# 4. Overwrite the HAProxy configuration file
echo "Overwriting HAProxy configuration file..."
echo "$HAPROXY_CONFIG_CONTENT" | sudo tee /etc/haproxy/haproxy.cfg > /dev/null

# 5. Ensure HAProxy is enabled to start via init script (required)
echo "Enabling HAProxy service..."
sudo sed -i 's/^ENABLED=0/ENABLED=1/' /etc/default/haproxy 
# Fallback method just in case 'sed' fails:
if ! grep -q "ENABLED=1" /etc/default/haproxy; then
    echo "ENABLED=1" | sudo tee -a /etc/default/haproxy
fi

# 6. Restart HAProxy to apply the new configuration
echo "Restarting HAProxy service..."
sudo service haproxy restart

echo "HAProxy configuration complete. The server names 'web-01' and 'web-02' are included."
